<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
  <Product
    Id="*"
    Name="Fleet osquery"
    Language="1033"
    Version="{{.Version}}"
    Manufacturer="Fleet Device Management (fleetdm.com)"
    UpgradeCode="B681CB20-107E-428A-9B14-2D3C1AFED244" >

    <Package
      Keywords='Fleet osquery'
      Description="Fleet osquery"
      InstallerVersion="500"
      Compressed="yes"
      InstallScope="perMachine"
      InstallPrivileges="elevated"
      Languages="1033" />

    <Property Id="REINSTALLMODE" Value="amus" />

    <!-- Cleanup any existing local database (to support downgrades and also to start fresh). -->
    <!--
      RemoveFolderEx requires that we "remember" the path for uninstall.
      Read the path value and set the OSQUERYDBFOLDER property with the value.
    -->
    <Property Id="OSQUERYDBFOLDER">
      <RegistrySearch Key="SOFTWARE\Fleet Device Management\OrbitFoo" Root="HKLM" Type="raw" Id="OSQUERYDBFOLDER_REGSEARCH" Name="Path" />
    </Property>
    <!-- Cleanup database on install -->
    <DirectoryRef Id="OSQUERYDBFOLDER">
      <Component Id="CleanupOsqueryDBFolderOnInstall" Guid="69E20B69-5691-4F0C-8178-70C130D73130">
        <Condition><![CDATA[Installed OR NOT MANUALPRODUCTFOUND]]></Condition>
        <RegistryValue Root="HKLM" Key="SOFTWARE\Fleet Device Management\OrbitFoo" Name="Path" Type="string" Value="[OSQUERYDBFOLDER]" KeyPath="yes" />
        <util:RemoveFolderEx On="install" Property="OSQUERYDBFOLDER" />
      </Component>
    </DirectoryRef>
    <!-- Cleanup database on uninstall -->
    <DirectoryRef Id="OSQUERYDBFOLDER">
      <Component Id="CleanupOsqueryDBFolder" Guid="9C425550-398D-4951-8960-F5AB7FB0B5BB">
        <RegistryValue Root="HKLM" Key="SOFTWARE\Fleet Device Management\OrbitFoo" Name="Path" Type="string" Value="[OSQUERYDBFOLDER]" KeyPath="yes" />
        <!-- We need to use OSQUERYDBFOLDER variable here or RemoveFolderEx will not remove on "install". -->
        <util:RemoveFolderEx On="uninstall" Property="OSQUERYDBFOLDER" />
      </Component>
    </DirectoryRef>

    <MediaTemplate EmbedCab="yes" />

    <MajorUpgrade AllowDowngrades="yes" />

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="ORBITROOT" Name="Orbit">
          <Component Id="C_ORBITROOT" Guid="A7DFD09E-2D2B-4535-A04F-5D4DE90F3863">
            <CreateFolder>
              <PermissionEx Sddl="O:SYG:SYD:P(A;OICI;FA;;;SY)(A;OICI;FA;;;BA)(A;OICI;0x1200a9;;;BU)" />
            </CreateFolder>
          </Component>

          <Directory Id="OSQUERYDBFOLDER" Name="osquery.db">
              <Component Id="C_ORBIT_OSQUERYDB" Guid="D63126A9-63F2-40A7-B95F-4352382698B3" />
          </Directory>

          <Directory Id="ORBITBIN" Name="bin">
            <Directory Id="ORBITBINORBIT" Name="orbit">

              <Component Id="C_ORBITBIN" Guid="AF347B4E-B84B-4DD4-9C4D-133BE17B613D">
                <CreateFolder>
                  <PermissionEx Sddl="O:SYG:SYD:P(A;OICI;FA;;;SY)(A;OICI;FA;;;BA)(A;OICI;0x1200a9;;;BU)" />
                </CreateFolder>
                <File Source="root\bin\orbit\windows\{{ .OrbitChannel }}\orbit.exe">
                  <PermissionEx Sddl="O:SYG:SYD:P(A;OICI;FA;;;SY)(A;OICI;FA;;;BA)(A;OICI;0x1200a9;;;BU)" />
                </File>
                <Environment Id='OrbitUpdateInterval' Name='ORBIT_UPDATE_INTERVAL' Value='{{ .OrbitUpdateInterval }}' Action='set' System='yes' />
                <!--
                  ##############################################################################################
                  NOTE: We've seen some system fail to install the MSI when using Account="NT AUTHORITY\SYSTEM"
                  ##############################################################################################
                  -->
                <ServiceInstall
                  Name="Fleet osquery"
                  Account="LocalSystem"
                  ErrorControl="ignore"
                  Start="auto"
                  Type="ownProcess"
                  Description="This service runs Fleet's osquery runtime and autoupdater (Orbit)."
                  Arguments='--root-dir "[ORBITROOT]." --log-file "[System64Folder]config\systemprofile\AppData\Local\FleetDM\Orbit\Logs\orbit-osquery.log"{{ if .FleetURL }} --fleet-url "{{ .FleetURL }}"{{ end }}{{ if .FleetCertificate }} --fleet-certificate "[ORBITROOT]fleet.pem"{{ end }}{{ if .EnrollSecret }} --enroll-secret-path "[ORBITROOT]secret.txt"{{ end }}{{if .Insecure }} --insecure{{ end }}{{ if .Debug }} --debug{{ end }}{{ if .UpdateURL }} --update-url "{{ .UpdateURL }}"{{ end }}{{ if .DisableUpdates }} --disable-updates{{ end }}{{ if .Desktop }} --fleet-desktop --desktop-channel {{ .DesktopChannel }}{{ end }} --orbit-channel "{{ .OrbitChannel }}" --osqueryd-channel "{{ .OsquerydChannel }}"'
                >
                  <util:ServiceConfig
                    FirstFailureActionType="restart"
                    SecondFailureActionType="restart"
                    ThirdFailureActionType="restart"
                    ResetPeriodInDays="1"
                    RestartServiceDelayInSeconds="1"
                  />
                </ServiceInstall>
                <ServiceControl
                  Id="StartOrbitService"
                  Name="Fleet osquery"
                  Start="install"
                  Stop="both"
                  Remove="uninstall"
                />
              </Component>
            </Directory>
          </Directory>
        </Directory>
      </Directory>
    </Directory>

    <Feature Id="Orbit" Title="Fleet osquery" Level="1" Display="hidden">
      <ComponentGroupRef Id="OrbitFiles" />
      <ComponentRef Id="C_ORBITBIN" />
      <ComponentRef Id="C_ORBITROOT" />
      <ComponentRef Id="CleanupOsqueryDBFolderOnInstall" />
      <ComponentRef Id="CleanupOsqueryDBFolder" />
    </Feature>

  </Product>
</Wix>