# MDM Base Setup

Note: these can all be namespaced behind something like `apple-mdm` if needed. But I would like to avoid creating an mdm vertical vs. an osquery vertical to create an integrated product.

## APNS
### Step 1 - Generate CSR
``` sh
$ fleetctl setup apns init
Generating MDM keys at ./
  fleet-apns-pki.crt ... done
  fleet-apns-pki.key ... done
  fleet-apns-push.key ... done
  fleet-apns-push.csr ... done
Send the .csr and .crt files to your friendly Fleet representative

Keep the .key files. You will need them to complete this process. 

Fleet will return a signed certificate to you within 1 business day. Use that file with the .key files in the `fleetctl setup apns gen-req` command.
```

### Step 2 - Generate .req file from .p7
``` bash
$ fleetctl setup apns gen-req \
--p7-file=~/path/to/*.p7 \
--pki-key=~/path/to/fleet-apns-pki.key \
--pki-crt=~/path/to/fleet-apns-pki.crt
Working...
Generated fleet-apns-push.req file at ./

Visit identity.apple.com to upload this .req file. For more details, follow these instructions: NEED LINK HERE

Apple will generate a .crt file. Use that file with the .key files in the `fleetctl setup apns finalize` command. 
```

### Step 3 - Upload push..crt and push.key files to Fleet ENV

```sh
$ fleetctl setup apns finalize \
--apple-crt=/path/to/apple.crt \
--push-key=/path/to/fleetctl-apns-push.key \
--context=dogfood
This command will update your Fleet Server's APNS environment variables with the content of the specified files. 

Continue? (Y/n)

Updating ENV["NEED_VARNAME"] with contents of /path/to/apple.crt
Updating ENV["NEED_VARNAME"] with contents of /path/to/fleetctl-apns-push.key
```

## SCEP
### Step 1 - Generate SCEP CA keys
```bash
$ fleetctl setup scep-ca init
Generating SCEP CA and keys at ./
  fleet-scep.crt ... done
  fleet-scep.key ... done
  
Next, use these file in the `fleetctl setup scep-ca finalize` command.
```

### Step 2 - Update fleet server ENV vars with new certs
```bash
$ fleetctl setup scep-ca finalize \ 
--scep-crt=/path/to/fleet-scep.crt \
--scep-key=/path/to/fleet-scep.key \
--context=dogfood
This command will update your Fleet Server's SCEP environment variables with the content of the specified files. 

WARNING: If you change the SCEP CA in the fleet server, you must un-enroll and re-enroll all devices.

Continue? (Y/n)

Updating ENV["NEED_VARNAME"] with contents of /path/to/fleet-scep.crt
Updating ENV["NEED_VARNAME"] with contents of /path/to/fleet-scep.key
```

## Misc
### Error States
#### Missing required flag
Matches current behavior of `fleetctl`: Simply shows the help page (try `fleetctl setup --name="hello"`)
#### Required file does not exist 
Matches current behavior of `fleetctl`: `Error: open does/not/exist: no such file or directory`
(Try `fleetctl apply -f does/not/exist`)
### Help pages - Setup

```bash
$ fleetctl setup
NAME:
   fleetctl setup - Set up a Fleet instance or MDM // UPDATED

USAGE:
   fleetctl setup [options]
   fleetctl setup apns // NEW
   fleetctl setup scep // NEW
   
SUBCOMMANDS:
	apns Apple Push Notification Service to enable MDM for Apple devices
	scep Simple Certificate Enrollment Protocol to enable MDM

OPTIONS:
	... // remains same
```

### Help pages - APNS

``` bash
// ALL NEW
$ fleetctl setup apns
NAME:
	fleetctl setup apns - Set up Apple Push Notification Service to enable Apple MDM

USAGE:
	fleetctl setup apns command

COMMANDS:
	init     Generate the necessary files to set up APNS
	gen-req  Generate the .req file for Apple from the .p7 file from Fleet
	finalize Set the SCEP certs in the Fleet Server's environment variables
```

``` bash
// ALL NEW
$ fleetctl setup apns init
NAME:
	fleetctl setup apns init - Generates the necessary files to set up APNS 

USAGE:
	fleetctl setup apns init
```

``` bash
// ALL NEW
$ fleetctl setup apns gen-req
NAME:
	fleetctl setup apns gen-req - Generate a .req file from a .p7 file provided by FleetDM, Inc.

USAGE:
	fleetctl setup apns gen-req [options]

OPTIONS:
  --p7-file value  Path to the .p7 file provided by FleetDM, Inc. (required)
  --pki-key value  Path to the fleet-apns-pki.key file generated by the `fleetctl setup apns init` command (required)
  --pki-crt value  Path to the fleet-apns-pki.crt file generated by the `fleetctl setup apns init` command (required)
  --context value  Name of fleetctl config context to use (default: "default") [$CONTEXT]
```

``` bash
// ALL NEW
$ fleetctl setup apns finalize
NAME:
	fleetctl setup apns finalize - Set the APNS certs in the Fleet Server's environment variables

USAGE:
	fleetctl setup apns finalize [options]

OPTIONS:
	--apple-crt value Path to the .crt file provided by Apple (required)
	--push-key value  Path to the fleet-apns-push.key file generated by the `fleetctl setup apns init` command (required)
  --context value   Name of fleetctl config context to use (default: "default") [$CONTEXT]
```

### Help Pages - SCEP

``` bash
// ALL NEW
$ fleetctl setup scep
NAME:
	fleetctl setup scep - Set up Simple Certificate Enrollment Protocol to enable MDM

USAGE:
	fleetctl setup scep command

COMMANDS:
	init     Generate the necessary files to set up SCEP
	finalize Set the SCEP certs in the Fleet Server's environment variables
```

``` bash
// ALL NEW
$ fleetctl setup apns init
NAME:
	fleetctl setup apns init - Generates the necessary files to set up APNS 

USAGE:
	fleetctl setup apns init
```

``` bash
// ALL NEW
$ fleetctl setup scep finalize
NAME:
	fleetctl setup scep finalize - Set the SCEP certs in the Fleet Server's environment variables

USAGE:
	fleetctl setup scep finalize [options]

OPTIONS:
  --scep-crt value  Path to the fleet-cry file generated by the `fleetctl setup scep init` command (required)   
  --scep-key value  Path to the fleet-scep.key file generated by the `fleetctl setup scep init` command (required)  
  --context value   Name of fleetctl config context to use (default: "default") [$CONTEXT]
```

## New API endpoints
1. Update APNS certs
2. Update SCEP certs
