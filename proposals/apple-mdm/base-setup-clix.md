# MDM Base Setup

Note: these can all be namespaced behind something like `apple-mdm` if needed. But I would like to avoid creating an mdm vertical vs. an osquery vertical to create an integrated product.

## Items of Note
- A few NO-OP commands (setup apple-mdm, scep finalize, apns finalize) which are pure instruction gathering only
- Setup integrated into fleetctl, not namespaced into a separate vertical (e.g. `fleetctl apple-mdm`). That might happen later, but not for setup.
- 

- TODO: Need link for apple's instructions on how to upload .req file
- TODO: Need clearer instructions for who/how to contact fleet
- TODO: Need to communicate some expectation of time to receive fleet .p7m file back

## fleetctl setup

```
$ fleetctl setup
NAME:
   fleetctl setup - Set up a Fleet instance or MDM // UPDATED

USAGE:
   fleetctl setup [options]
   fleetctl setup apple-mdm // NEW
   fleetctl setup apns // NEW
   fleetctl setup scep // NEW
   
SUBCOMMANDS:
  apple-mdm Instructions for enabling MDM for Apple devices
	apns Apple Push Notification Service to enable MDM for Apple devices // New
	scep Simple Certificate Enrollment Protocol to enable MDM for Apple devices // NEW

OPTIONS:
	... // remains same
```

```
$ fleetctl setup apple-mdm
NAME:
	fleetctl setup apple-mdm - Instructions for enabling MDM for Apple devices

INSTRUCTIONS:
  Welcome! Here are instructions for enabling MDM for Apple devices in Fleet.

  1. Run and complete the instructions in the `fleetctl setup apns` set of commands
  2. Run and complete the instructions in the `fleetctl setup scep` set of commands
  3. Set the ENV["APPLE_MDM_ENABLE"]=1 in your fleet server
```

## APNS

```
$ fleetctl setup apns
NAME:
	fleetctl setup apns - Set up Apple Push Notification Service to enable MDM for Apple devices

USAGE:
	fleetctl setup apns command

COMMANDS:
	init     Generate the necessary files to set up APNS
	gen-req  Generate the .req file for Apple from the .p7m file from Fleet
	finalize Instructions for setting the APNS certs in the Fleet Server's environment variables
```

### Step 1 - Generate CSR
```
$ fleetctl setup apns init
Generating APNS keys at ./
  fleet-apns-pki.crt ... done
  fleet-apns-pki.key ... done
  fleet-apns-push.key ... done
  fleet-apns-push.csr ... done
Send the .csr and .crt files to your friendly Fleet representative

Keep the .key files. You will need them to complete this process. 

Fleet will return a .p7m file to you within (TODO) business days. Use that file in the `fleetctl setup apns gen-req` command.
```

### Step 2 - Generate .req file from .p7m

```
$ fleetctl setup apns gen-req
NAME:
	fleetctl setup apns gen-req - Generate a .req file from a .p7m file provided by FleetDM, Inc.

USAGE:
	fleetctl setup apns gen-req [options]

OPTIONS:
  --p7m-file value  Path to the .p7m file provided by FleetDM, Inc. (required)
  --pki-key value  Path to the fleet-apns-pki.key file generated by the `fleetctl setup apns init` command (required)
  --pki-crt value  Path to the fleet-apns-pki.crt file generated by the `fleetctl setup apns init` command (required)
```
```
$ fleetctl setup apns gen-req \
-.p7m-file=~/path/to/*.p7m \
--pki-key=~/path/to/fleet-apns-pki.key \
--pki-crt=~/path/to/fleet-apns-pki.crt
Working...
Generated fleet-apns-push.req file at ./

Visit identity.apple.com to upload this .req file. For more details, follow these instructions: TODO LINK

Apple will generate a .crt file. Use that file in the `fleetctl setup apns finalize` command. 
```

### Step 3 - Upload push..crt and push.key files to Fleet ENV

```sh
$ fleetctl setup apns finalize
Update your Fleet server's environment variables as follows:
1. Update ENV["APNS_PUSH_CERT"] with the contents of the Apple .crt file
2. Update ENV["APNS_PUSH_KEY"] with the contents of fleet-apns-push.key

Restart the server to apply the new ENV variables.

```

## SCEP
```
$ fleetctl setup scep
NAME:
	fleetctl setup scep - Set up Simple Certificate Enrollment Protocol to enable MDM for Apple Devices

USAGE:
	fleetctl setup scep command

COMMANDS:
	init     Generate the necessary files to set up SCEP
	finalize Instructions for setting the SCEP certs in the Fleet Server's environment variables
```
### Step 1 - Generate SCEP CA keys
```
$ fleetctl setup scep-ca init
Generating SCEP CA and keys at ./
  fleet-scep.crt ... done
  fleet-scep.key ... done
  
Next, use these file in the `fleetctl setup scep-ca finalize` command.
```

### Step 2 - Update fleet server ENV vars with new certs
```
$ fleetctl setup scep-ca finalize
WARNING: If you change the SCEP CA in the fleet server, existing managed devices will no longer report to Fleet. You must un-enroll and re-enroll all devices.

Update your Fleet server's environment variables as follows:
1. Update ENV["SCEP_CA_CERT"] with the contents of fleetctl-scep.crt
2. Update ENV["SCEP_CA_KEY"] with the contents of fleetctl-scep.key

Restart the server to apply the new ENV variables.

```

## Misc
### Error States
#### Missing required flag
Matches current behavior of `fleetctl`: Simply shows the help page. (To simulate this, try `fleetctl setup --name="hello"`)

#### Required file does not exist 
Matches current behavior of `fleetctl`: "`Error: open does/not/exist: no such file or directory`".

(To simulate this, try `fleetctl apply -f does/not/exist`)

## New API endpoints
None needed for this effort.
