# MDM Base Setup

Note: these can all be namespaced behind something like `apple-mdm` if needed. But I would like to avoid creating an mdm vertical vs. an osquery vertical to create an integrated product.

## APNS
### Step 1 - Generate CSR
```
$ fleetctl setup apns init
Generating APNS keys at ./
  fleet-apns-pki.crt ... done
  fleet-apns-pki.key ... done
  fleet-apns-push.key ... done
  fleet-apns-push.csr ... done
Send the .csr and .crt files to your friendly Fleet representative

Keep the .key files. You will need them to complete this process. 

Fleet will return a .p7m file to you within (TODO) business days. Use that file in the `fleetctl setup apns gen-req` command.
```

### Step 2 - Generate .req file from .p7m
```
$ fleetctl setup apns gen-req \
--p7-file=~/path/to/*.p7 \
--pki-key=~/path/to/fleet-apns-pki.key \
--pki-crt=~/path/to/fleet-apns-pki.crt
Working...
Generated fleet-apns-push.req file at ./

Visit identity.apple.com to upload this .req file. For more details, follow these instructions: NEED LINK HERE

Apple will generate a .crt file. Use that file in the `fleetctl setup apns finalize` command. 
```

### Step 3 - Upload push..crt and push.key files to Fleet ENV

```sh
$ fleetctl setup apns finalize
Update your Fleet server's environment variables as follows:
1. Update ENV["APPLE_MDM_ENABLE"]=1
2. Update ENV["APNS_PUSH_CERT"] with the contents of the Apple .crt file
3. Update ENV["APNS_PUSH_KEY"] with the contents of fleet-apns-push.key

Restart the server to apply the new ENV variables.

```

## SCEP
### Step 1 - Generate SCEP CA keys
```
$ fleetctl setup scep-ca init
Generating SCEP CA and keys at ./
  fleet-scep.crt ... done
  fleet-scep.key ... done
  
Next, use these file in the `fleetctl setup scep-ca finalize` command.
```

### Step 2 - Update fleet server ENV vars with new certs
```
$ fleetctl setup scep-ca finalize
WARNING: If you change the SCEP CA in the fleet server, existing managed devices will no longer report to Fleet. You must un-enroll and re-enroll all devices.

Update your Fleet server's environment variables as follows:
1. Update ENV["SCEP_CA_CERT"] with the contents of fleetctl-scep.crt
2. Update ENV["SCEP_CA_KEY"] with the contents of fleetctl-scep.key

Restart the server to apply the new ENV variables.

```

## Misc
### Error States
#### Missing required flag
Matches current behavior of `fleetctl`: Simply shows the help page. (To simulate this, try `fleetctl setup --name="hello"`)

#### Required file does not exist 
Matches current behavior of `fleetctl`: "`Error: open does/not/exist: no such file or directory`".

(To simulate this, try `fleetctl apply -f does/not/exist`)
### Help pages - Setup

```
$ fleetctl setup
NAME:
   fleetctl setup - Set up a Fleet instance or MDM // UPDATED

USAGE:
   fleetctl setup [options]
   fleetctl setup apns // NEW
   fleetctl setup scep // NEW
   
SUBCOMMANDS:
	apns Apple Push Notification Service to enable MDM for Apple devices // New
	scep Simple Certificate Enrollment Protocol to enable MDM for Apple devices // NEW

OPTIONS:
	... // remains same
```

### Help pages - APNS

```
// ALL NEW
$ fleetctl setup apns
NAME:
	fleetctl setup apns - Set up Apple Push Notification Service to enable MDM for Apple devices

USAGE:
	fleetctl setup apns command

COMMANDS:
	init     Generate the necessary files to set up APNS
	gen-req  Generate the .req file for Apple from the .p7 file from Fleet
	finalize Set the SCEP certs in the Fleet Server's environment variables
```

```
// ALL NEW
$ fleetctl setup apns init
NAME:
	fleetctl setup apns init - Generates the necessary files to set up APNS 

USAGE:
	fleetctl setup apns init
```

```
// ALL NEW
$ fleetctl setup apns gen-req
NAME:
	fleetctl setup apns gen-req - Generate a .req file from a .p7 file provided by FleetDM, Inc.

USAGE:
	fleetctl setup apns gen-req [options]

OPTIONS:
  --p7-file value  Path to the .p7 file provided by FleetDM, Inc. (required)
  --pki-key value  Path to the fleet-apns-pki.key file generated by the `fleetctl setup apns init` command (required)
  --pki-crt value  Path to the fleet-apns-pki.crt file generated by the `fleetctl setup apns init` command (required)
  --context value  Name of fleetctl config context to use (default: "default") [$CONTEXT]
```

```
// ALL NEW
$ fleetctl setup apns finalize
NAME:
	fleetctl setup apns finalize - Set the APNS certs in the Fleet Server's environment variables

USAGE:
	fleetctl setup apns finalize [options]

OPTIONS:
	--apple-crt value Path to the .crt file provided by Apple (required)
	--push-key value  Path to the fleet-apns-push.key file generated by the `fleetctl setup apns init` command (required)
  --context value   Name of fleetctl config context to use (default: "default") [$CONTEXT]
```

### Help Pages - SCEP

```
// ALL NEW
$ fleetctl setup scep
NAME:
	fleetctl setup scep - Set up Simple Certificate Enrollment Protocol to enable MDM for Apple Devices

USAGE:
	fleetctl setup scep command

COMMANDS:
	init     Generate the necessary files to set up SCEP
	finalize Set the SCEP certs in the Fleet Server's environment variables
```

```
// ALL NEW
$ fleetctl setup scep finalize
NAME:
	fleetctl setup scep finalize - Set the SCEP certs in the Fleet Server's environment variables

USAGE:
	fleetctl setup scep finalize [options]

OPTIONS:
  --scep-crt value  Path to the fleet-cry file generated by the `fleetctl setup scep init` command (required)   
  --scep-key value  Path to the fleet-scep.key file generated by the `fleetctl setup scep init` command (required)  
  --context value   Name of fleetctl config context to use (default: "default") [$CONTEXT]
```

## New API endpoints
None needed for this effort.
