# MDM Base Setup @ Dogfood

## Items of Note
- A NO-OP command (setup apple-mdm) which are pure instruction gathering only
- Setup integrated into fleetctl, not namespaced into a separate vertical (e.g. `fleetctl apple-mdm`). That might happen at other parts of the UX, but not for setup.

## fleetctl setup

```
$ fleetctl setup
NAME:
   fleetctl setup - Set up a Fleet instance or MDM

USAGE:
   fleetctl setup [options]
   fleetctl setup apple-mdm
   fleetctl setup apns
   fleetctl setup scep
   
SUBCOMMANDS:
  apple-mdm  Instructions for enabling MDM for Apple devices
  apns       Apple Push Notification Service to enable MDM for Apple devices
  scep       Simple Certificate Enrollment Protocol to enable MDM for Apple devices

OPTIONS:
	... // remains same
```

```
$ fleetctl setup apple-mdm
NAME:
  fleetctl setup apple-mdm - Instructions for enabling MDM for Apple devices

INSTRUCTIONS:
  Welcome! Here are instructions for enabling MDM for Apple devices in Fleet.

  1. Run and complete the instructions in the `fleetctl setup apns` set of commands
  2. Run and complete the instructions in the `fleetctl setup scep` set of commands
  3. Set the ENV["FLEET_APPLE_MDM_ENABLE"]=1 in your fleet server

  For more information on how to change your environment variables in Fleet, visit https://fleetdm.com/docs/deploying/configuration#options
```

## APNS

```
$ fleetctl setup apns
NAME:
  fleetctl setup apns - Set up Apple Push Notification Service to enable MDM for Apple devices

USAGE:
  fleetctl setup apns command

COMMANDS:
  init     Generate the necessary files to set up APNS
  gen-req  Generate the .req file for Apple from the .p7m file from Fleet
```

### Step 1 - Generate CSR
```
$ fleetctl setup apns init
Generating APNS keys at ./
  fleet-apns-pki.crt ... done
  fleet-apns-pki.key ... done
  fleet-apns-push.key ... done
  fleet-apns-push.csr ... done

Send the .csr and .crt files to your friendly Fleet representative. Apple requires Fleet to collect contact info for MDM cert users. We intend to automate this process soon, but for now, if you are interested in trying out Apple MDM via Fleet, please reach out to us at https://fleetdm.com/company/contact to get set up.

Keep the .key files. You will need them to complete this process.

Fleet will return a .p7m file to you. Use that file and he other generated files in the `fleetctl setup apns gen-req` command.
```

### Step 2 - Generate .req file from .p7m

```
$ fleetctl setup apns gen-req
NAME:
  fleetctl setup apns gen-req - Generate a .req file from a .p7m file provided by FleetDM, Inc.

USAGE:
  fleetctl setup apns gen-req [options]

OPTIONS:
  --p7m-file value  Path to the .p7m file provided Fleet (required)
  --pki-key value   Path to the fleet-apns-pki.key file generated by the `fleetctl setup apns init` command (required)
  --pki-crt value   Path to the fleet-apns-pki.crt file generated by the `fleetctl setup apns init` command (required)
```

```
$ fleetctl setup apns gen-req \
--p7m-file=~/path/to/*.p7m \
--pki-key=~/path/to/fleet-apns-pki.key \
--pki-crt=~/path/to/fleet-apns-pki.crt
Working...
Generated fleet-apns-push.req file at ./

Visit identity.apple.com/pushcert to upload this .req file. Apple will generate a .crt file for you.

Re-run your Fleet server with new environment variables as follows:
1. Update ENV["FLEET_APNS_PUSH_CERT"] with the contents of the Apple .crt file
2. Update ENV["FLEET_APNS_PUSH_KEY"] with the contents of fleet-apns-push.key

For more information on how to change your environment variables in Fleet, visit https://fleetdm.com/docs/deploying/configuration#options

```

## SCEP Certificate Authority
### Step 1 - Generate SCEP CA keys
```
$ fleetctl setup scep
Generating SCEP CA and keys at ./
  fleet-scep.crt ... done
  fleet-scep.key ... done

Re-run your Fleet server with new environment variables as follows:
1. Update ENV["FLEET_SCEP_CA_CERT"] with the contents of fleetctl-scep.crt
2. Update ENV["FLEET_SCEP_CA_KEY"] with the contents of fleetctl-scep.key

For more information on how to change your environment variables in Fleet, visit https://fleetdm.com/docs/deploying/configuration#options

WARNING: If you change the SCEP CA in the Fleet server, existing managed devices will no longer report to Fleet. You must un-enroll and re-enroll all devices.

```

## Misc
### Error States
#### Missing required flag
Matches current behavior of `fleetctl`: Simply shows the help page. (To simulate this, try `fleetctl setup --name="hello"`)

#### Required file does not exist 
Matches current behavior of `fleetctl`: "`Error: open does/not/exist: no such file or directory`".

(To simulate this, try `fleetctl apply -f does/not/exist`)

## New API endpoints
None needed for this effort.
